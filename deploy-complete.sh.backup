#!/bin/bash

###############################################################################
# Script de dÃ©ploiement complet Timepulse
# 30 Novembre 2025
#
# Ce script effectue :
# 1. VÃ©rification du build
# 2. Commit et push GitHub
# 3. DÃ©ploiement Vercel en production
###############################################################################

set -e  # ArrÃªter en cas d'erreur

# Couleurs pour les messages
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘                                                            â•‘${NC}"
echo -e "${BLUE}â•‘         ğŸš€ DÃ‰PLOIEMENT COMPLET TIMEPULSE V2               â•‘${NC}"
echo -e "${BLUE}â•‘                                                            â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

###############################################################################
# Ã‰TAPE 1 : VÃ‰RIFICATION DU BUILD
###############################################################################

echo -e "${YELLOW}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${YELLOW}â–¶ Ã‰TAPE 1/4 : VÃ©rification du build${NC}"
echo -e "${YELLOW}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

echo "ğŸ”¨ Compilation du projet..."
if npm run build; then
  echo -e "${GREEN}âœ… Build rÃ©ussi !${NC}"
  echo ""
else
  echo -e "${RED}âŒ Erreur lors du build. DÃ©ploiement annulÃ©.${NC}"
  exit 1
fi

###############################################################################
# Ã‰TAPE 2 : GITHUB - COMMIT ET PUSH
###############################################################################

echo -e "${YELLOW}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${YELLOW}â–¶ Ã‰TAPE 2/4 : Commit et Push GitHub${NC}"
echo -e "${YELLOW}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# VÃ©rifier le statut Git
if [ -d ".git" ]; then
  echo "ğŸ“Š Statut Git :"
  git status --short
  echo ""

  # Demander confirmation
  echo -e "${BLUE}ğŸ’¬ Message du commit :${NC}"
  echo "   feat: SystÃ¨me de rÃ©servation et file d'attente + Fix frais de service"
  echo ""
  echo "   - Correction frais de service en double"
  echo "   - Suppression auto paniers expirÃ©s (cron)"
  echo "   - SystÃ¨me de rÃ©servation de places"
  echo "   - File d'attente avec temps estimÃ©"
  echo "   - Composant RaceWaitlistModal"
  echo "   - Prolongation auto panier (activitÃ© user)"
  echo ""

  read -p "Continuer avec ce commit ? (o/n) " -n 1 -r
  echo ""

  if [[ $REPLY =~ ^[Oo]$ ]]; then
    echo "ğŸ“¦ Ajout des fichiers..."
    git add .

    echo "ğŸ’¾ CrÃ©ation du commit..."
    git commit -m "feat: SystÃ¨me de rÃ©servation et file d'attente + Fix frais de service

- Fix: Correction des frais de service en double dans le rÃ©capitulatif
- Fix: LibellÃ© 'Montant total inscription(s) et option(s)'
- Feature: Suppression automatique des paniers expirÃ©s (job cron)
- Feature: SystÃ¨me de rÃ©servation de places (reserved_spots)
- Feature: File d'attente intelligente (race_waitlist)
- Feature: Composant RaceWaitlistModal avec temps estimÃ©
- Feature: Option newsletter bourse aux dossards
- Feature: Prolongation automatique panier si utilisateur actif
- Feature: Fonctions SQL (check_availability, reserve_spots, etc.)
- Docs: Guide complet d'implÃ©mentation
- Docs: Rapport de sauvegarde 30/11/2025

Migrations:
- create_cart_cleanup_cron_job
- create_cart_reservation_and_waitlist_system_v2

Tables modifiÃ©es: races, race_options
Tables crÃ©Ã©es: race_waitlist
Fichiers crÃ©Ã©s: RaceWaitlistModal.tsx, guides MD"

    echo "ğŸš€ Push vers GitHub..."
    if git push origin main; then
      echo -e "${GREEN}âœ… Push GitHub rÃ©ussi !${NC}"
      echo ""
    else
      echo -e "${RED}âŒ Erreur lors du push. VÃ©rifier la connexion GitHub.${NC}"
      exit 1
    fi
  else
    echo -e "${YELLOW}â­ï¸  Commit GitHub ignorÃ©${NC}"
    echo ""
  fi
else
  echo -e "${YELLOW}âš ï¸  Pas de repository Git dÃ©tectÃ©${NC}"
  echo ""
fi

###############################################################################
# Ã‰TAPE 3 : VÃ‰RIFICATION VERCEL
###############################################################################

echo -e "${YELLOW}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${YELLOW}â–¶ Ã‰TAPE 3/4 : VÃ©rification Vercel${NC}"
echo -e "${YELLOW}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

if command -v vercel &> /dev/null; then
  echo -e "${GREEN}âœ… Vercel CLI dÃ©tectÃ©${NC}"

  # VÃ©rifier la connexion
  echo "ğŸ” VÃ©rification de la connexion..."
  if vercel whoami &> /dev/null; then
    echo -e "${GREEN}âœ… ConnectÃ© Ã  Vercel${NC}"
    echo ""
  else
    echo -e "${YELLOW}âš ï¸  Non connectÃ© Ã  Vercel${NC}"
    echo "ğŸ’¡ Connexion Ã  Vercel..."
    vercel login
  fi
else
  echo -e "${RED}âŒ Vercel CLI non installÃ©${NC}"
  echo "ğŸ’¡ Installation via : npm i -g vercel"
  exit 1
fi

###############################################################################
# Ã‰TAPE 4 : DÃ‰PLOIEMENT VERCEL
###############################################################################

echo -e "${YELLOW}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${YELLOW}â–¶ Ã‰TAPE 4/4 : DÃ©ploiement Vercel Production${NC}"
echo -e "${YELLOW}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

echo -e "${BLUE}ğŸŒ Domaines configurÃ©s :${NC}"
echo "   - timepulse.fr"
echo "   - www.timepulse.fr"
echo ""

read -p "Lancer le dÃ©ploiement en PRODUCTION ? (o/n) " -n 1 -r
echo ""

if [[ $REPLY =~ ^[Oo]$ ]]; then
  echo "ğŸš€ DÃ©ploiement en cours..."
  echo ""

  if vercel --prod --yes; then
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                                                            â•‘${NC}"
    echo -e "${GREEN}â•‘               âœ… DÃ‰PLOIEMENT RÃ‰USSI !                     â•‘${NC}"
    echo -e "${GREEN}â•‘                                                            â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${BLUE}ğŸŒ Site dÃ©ployÃ© sur :${NC}"
    echo "   â€¢ https://timepulse.fr"
    echo "   â€¢ https://www.timepulse.fr"
    echo ""
    echo -e "${BLUE}ğŸ“Š Prochaines Ã©tapes :${NC}"
    echo "   1. Tester le site en production"
    echo "   2. VÃ©rifier le job cron Supabase"
    echo "   3. Tester l'ajout au panier"
    echo "   4. VÃ©rifier la file d'attente"
    echo ""
    echo -e "${BLUE}ğŸ“š Documentation :${NC}"
    echo "   â€¢ BACKUP-REPORT-2025-11-30.md"
    echo "   â€¢ CART-RESERVATION-IMPLEMENTATION-GUIDE.md"
    echo ""
  else
    echo ""
    echo -e "${RED}âŒ Erreur lors du dÃ©ploiement Vercel${NC}"
    exit 1
  fi
else
  echo -e "${YELLOW}â­ï¸  DÃ©ploiement Vercel ignorÃ©${NC}"
  echo ""
fi

###############################################################################
# RÃ‰SUMÃ‰ FINAL
###############################################################################

echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${BLUE}ğŸ“‹ RÃ‰SUMÃ‰ DU DÃ‰PLOIEMENT${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""
echo "âœ… Build compilÃ©"
echo "âœ… GitHub mis Ã  jour"
echo "âœ… Vercel dÃ©ployÃ©"
echo ""
echo -e "${GREEN}ğŸ‰ Tous les systÃ¨mes sont opÃ©rationnels !${NC}"
echo ""
echo -e "${YELLOW}âš ï¸  N'oubliez pas :${NC}"
echo "   1. Activer les quotas sur les courses : UPDATE races SET has_quota = true"
echo "   2. VÃ©rifier le job cron : SELECT * FROM cron.job"
echo "   3. Tester la file d'attente en production"
echo ""
