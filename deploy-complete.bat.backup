@echo off
chcp 65001 >nul
setlocal enabledelayedexpansion

:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:: Script de dÃ©ploiement complet Timepulse (Windows)
:: 30 Novembre 2025
::
:: Ce script effectue :
:: 1. VÃ©rification du build
:: 2. Commit et push GitHub
:: 3. DÃ©ploiement Vercel en production
:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

echo.
echo â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
echo â•‘                                                            â•‘
echo â•‘         ğŸš€ DÃ‰PLOIEMENT COMPLET TIMEPULSE V2               â•‘
echo â•‘                                                            â•‘
echo â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.

:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:: Ã‰TAPE 1 : VÃ‰RIFICATION DU BUILD
:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

echo â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo â–¶ Ã‰TAPE 1/4 : VÃ©rification du build
echo â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.

echo ğŸ”¨ Compilation du projet...
call npm run build
if errorlevel 1 (
    echo.
    echo âŒ Erreur lors du build. DÃ©ploiement annulÃ©.
    pause
    exit /b 1
)

echo âœ… Build rÃ©ussi !
echo.

:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:: Ã‰TAPE 2 : GITHUB - COMMIT ET PUSH
:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

echo â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo â–¶ Ã‰TAPE 2/4 : Commit et Push GitHub
echo â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.

if exist ".git" (
    echo ğŸ“Š Statut Git :
    git status --short
    echo.

    echo ğŸ’¬ Message du commit :
    echo    feat: SystÃ¨me de rÃ©servation et file d'attente + Fix frais de service
    echo.
    echo    - Correction frais de service en double
    echo    - Suppression auto paniers expirÃ©s ^(cron^)
    echo    - SystÃ¨me de rÃ©servation de places
    echo    - File d'attente avec temps estimÃ©
    echo    - Composant RaceWaitlistModal
    echo    - Prolongation auto panier ^(activitÃ© user^)
    echo.

    set /p CONTINUE="Continuer avec ce commit ? (o/n) "
    if /i "!CONTINUE!"=="o" (
        echo ğŸ“¦ Ajout des fichiers...
        git add .

        echo ğŸ’¾ CrÃ©ation du commit...
        git commit -m "feat: SystÃ¨me de rÃ©servation et file d'attente + Fix frais de service" -m "- Fix: Correction des frais de service en double dans le rÃ©capitulatif" -m "- Fix: LibellÃ© 'Montant total inscription(s) et option(s)'" -m "- Feature: Suppression automatique des paniers expirÃ©s (job cron)" -m "- Feature: SystÃ¨me de rÃ©servation de places (reserved_spots)" -m "- Feature: File d'attente intelligente (race_waitlist)" -m "- Feature: Composant RaceWaitlistModal avec temps estimÃ©" -m "- Feature: Option newsletter bourse aux dossards" -m "- Feature: Prolongation automatique panier si utilisateur actif" -m "- Feature: Fonctions SQL (check_availability, reserve_spots, etc.)" -m "- Docs: Guide complet d'implÃ©mentation" -m "- Docs: Rapport de sauvegarde 30/11/2025" -m "" -m "Migrations:" -m "- create_cart_cleanup_cron_job" -m "- create_cart_reservation_and_waitlist_system_v2" -m "" -m "Tables modifiÃ©es: races, race_options" -m "Tables crÃ©Ã©es: race_waitlist" -m "Fichiers crÃ©Ã©s: RaceWaitlistModal.tsx, guides MD"

        echo ğŸš€ Push vers GitHub...
        git push origin main
        if errorlevel 1 (
            echo âŒ Erreur lors du push. VÃ©rifier la connexion GitHub.
            pause
            exit /b 1
        )

        echo âœ… Push GitHub rÃ©ussi !
        echo.
    ) else (
        echo â­ï¸  Commit GitHub ignorÃ©
        echo.
    )
) else (
    echo âš ï¸  Pas de repository Git dÃ©tectÃ©
    echo.
)

:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:: Ã‰TAPE 3 : VÃ‰RIFICATION VERCEL
:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

echo â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo â–¶ Ã‰TAPE 3/4 : VÃ©rification Vercel
echo â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.

where vercel >nul 2>&1
if errorlevel 1 (
    echo âŒ Vercel CLI non installÃ©
    echo ğŸ’¡ Installation via : npm i -g vercel
    pause
    exit /b 1
)

echo âœ… Vercel CLI dÃ©tectÃ©

echo ğŸ” VÃ©rification de la connexion...
vercel whoami >nul 2>&1
if errorlevel 1 (
    echo âš ï¸  Non connectÃ© Ã  Vercel
    echo ğŸ’¡ Connexion Ã  Vercel...
    vercel login
) else (
    echo âœ… ConnectÃ© Ã  Vercel
)
echo.

:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:: Ã‰TAPE 4 : DÃ‰PLOIEMENT VERCEL
:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

echo â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo â–¶ Ã‰TAPE 4/4 : DÃ©ploiement Vercel Production
echo â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.

echo ğŸŒ Domaines configurÃ©s :
echo    - timepulse.fr
echo    - www.timepulse.fr
echo.

set /p DEPLOY="Lancer le dÃ©ploiement en PRODUCTION ? (o/n) "
if /i "!DEPLOY!"=="o" (
    echo ğŸš€ DÃ©ploiement en cours...
    echo.

    vercel --prod --yes
    if errorlevel 1 (
        echo.
        echo âŒ Erreur lors du dÃ©ploiement Vercel
        pause
        exit /b 1
    )

    echo.
    echo â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    echo â•‘                                                            â•‘
    echo â•‘               âœ… DÃ‰PLOIEMENT RÃ‰USSI !                     â•‘
    echo â•‘                                                            â•‘
    echo â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    echo.
    echo ğŸŒ Site dÃ©ployÃ© sur :
    echo    â€¢ https://timepulse.fr
    echo    â€¢ https://www.timepulse.fr
    echo.
    echo ğŸ“Š Prochaines Ã©tapes :
    echo    1. Tester le site en production
    echo    2. VÃ©rifier le job cron Supabase
    echo    3. Tester l'ajout au panier
    echo    4. VÃ©rifier la file d'attente
    echo.
    echo ğŸ“š Documentation :
    echo    â€¢ BACKUP-REPORT-2025-11-30.md
    echo    â€¢ CART-RESERVATION-IMPLEMENTATION-GUIDE.md
    echo.
) else (
    echo â­ï¸  DÃ©ploiement Vercel ignorÃ©
    echo.
)

:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
:: RÃ‰SUMÃ‰ FINAL
:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

echo â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo ğŸ“‹ RÃ‰SUMÃ‰ DU DÃ‰PLOIEMENT
echo â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.
echo âœ… Build compilÃ©
echo âœ… GitHub mis Ã  jour
echo âœ… Vercel dÃ©ployÃ©
echo.
echo ğŸ‰ Tous les systÃ¨mes sont opÃ©rationnels !
echo.
echo âš ï¸  N'oubliez pas :
echo    1. Activer les quotas sur les courses : UPDATE races SET has_quota = true
echo    2. VÃ©rifier le job cron : SELECT * FROM cron.job
echo    3. Tester la file d'attente en production
echo.

pause
